{% extends "base.html" %}

{% block title %}配置合并 - Excel/CSV 汇总工具{% endblock %}

{% block extra_css %}
<style>
/* 工作表卡片样式 */
.sheet-config-card {
    border-left: 3px solid #0d6efd;
    transition: all 0.2s ease;
}

.sheet-config-card:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transform: translateX(2px);
}

.sheet-config-card .card-body {
    background-color: #f8f9fa;
}

.sheet-config-card .sheet-enable:checked ~ label {
    color: #0d6efd;
    font-weight: 600;
}

.file-config-container.opacity-50 {
    opacity: 0.5;
    pointer-events: none;
}

/* 工作表容器滚动条样式 */
.sheets-container {
    scrollbar-width: thin;
    scrollbar-color: #0d6efd #f8f9fa;
}

.sheets-container::-webkit-scrollbar {
    width: 8px;
}

.sheets-container::-webkit-scrollbar-track {
    background: #f8f9fa;
    border-radius: 4px;
}

.sheets-container::-webkit-scrollbar-thumb {
    background: #0d6efd;
    border-radius: 4px;
}

.sheets-container::-webkit-scrollbar-thumb:hover {
    background: #0a58ca;
}

/* 展开/折叠按钮动画 */
#toggle_btn i {
    transition: transform 0.3s ease;
}

/* 模态框无障碍性改进 */
.modal.fade {
    transition: opacity 0.15s linear;
}

.modal.fade .modal-dialog {
    transition: transform 0.15s ease-out;
}

/* 确保模态框关闭时正确处理焦点 */
.modal[aria-hidden="true"] button:focus,
.modal[aria-hidden="true"] [tabindex]:focus {
    outline: none !important;
    box-shadow: none !important;
}

/* 改善按钮焦点状态 */
.btn:focus {
    outline: 2px solid #0d6efd;
    outline-offset: 2px;
}

/* 拖拽排序样式 */
.column-config-table {
    position: relative;
}

.column-config-table tbody tr {
    transition: background-color 0.2s ease;
    /* 移除所有其他过渡效果以提高性能 */
}

.column-config-table tbody tr.drag-over {
    background-color: #e3f2fd !important;
    border: 2px dashed #2196f3 !important;
}

.column-config-table tbody tr.dragging {
    opacity: 0.6;
    transform: scale(0.98);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    position: relative;
    transition: none; /* 禁用过渡动画以提高性能 */
}

.drag-handle {
    cursor: move;
    user-select: none;
}

.drag-handle:hover {
    background-color: #f8f9fa;
    border-radius: 4px;
}

.drag-placeholder {
    background-color: transparent !important;
    border: none !important;
    height: 3px !important;
    padding: 0 !important;
}

.drag-placeholder td {
    padding: 0 !important;
    border: none !important;
    background: linear-gradient(90deg, #007bff, #0056b3) !important;
    border-radius: 2px;
    height: 3px !important;
    opacity: 0.8;
    animation: pulse 1s ease-in-out infinite alternate;
}

@keyframes pulse {
    from { opacity: 0.6; }
    to { opacity: 1; }
}

/* 拖拽时的视觉反馈 */
.column-config-table tbody tr:hover {
    background-color: #f8f9fa;
}

.column-config-table tbody tr.drag-target {
    border-top: 3px solid #007bff !important;
}

.drag-handle i {
    transition: color 0.2s ease;
}

.drag-handle:hover i {
    color: #007bff;
}

/* 性能优化 */
.column-config-table {
    transform: translateZ(0); /* 启用硬件加速 */
    will-change: auto;
}

.column-config-table tbody tr.dragging {
    will-change: transform, opacity; /* 仅在拖拽时启用 */
}

.column-config-table tbody tr:not(.dragging) {
    will-change: auto; /* 非拖拽状态下关闭 */
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">首页</a></li>
                <li class="breadcrumb-item active">配置合并</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-gear"></i> 文件配置与数据清洗设置
                </h5>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="copyFirstFileConfig()" title="将第一个文件的配置应用到其他文件">
                        <i class="bi bi-files"></i> 复制第一个文件配置
                    </button>
                    <button type="button" class="btn btn-outline-info btn-sm" onclick="showConfigManager()">
                        <i class="bi bi-gear"></i> 配置管理
                    </button>
                </div>
            </div>
            <div class="card-body">
                <form id="configForm">
                    <!-- 文件配置 -->
                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-primary"><i class="bi bi-files"></i> 文件配置</h6>
                            <hr>
                        </div>
                    </div>
                    
                    {% for file in files %}
                    <div class="card mb-3 file-config-container" data-file-id="{{ file.file_id }}">
                        <div class="card-header bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="form-check">
                                    <input class="form-check-input file-enable" type="checkbox" 
                                           value="{{ file.file_id }}" id="file_{{ file.file_id }}" checked>
                                    <label class="form-check-label fw-bold" for="file_{{ file.file_id }}">
                                        <i class="bi bi-file-earmark-{% if file.extension == 'csv' %}text{% else %}spreadsheet{% endif %}"></i>
                                        {{ file.original_filename }}
                                        <small class="text-muted">({{ (file.file_size / 1024 / 1024) | round(2) }} MB)</small>
                                        <span class="badge bg-secondary ms-2">{{ file.sheets|length }} 个工作表</span>
                                    </label>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-outline-secondary btn-sm me-2" 
                                            onclick="toggleSheetsContainer('{{ file.file_id }}')"
                                            id="toggle_btn_{{ file.file_id }}"
                                            title="展开/折叠工作表列表">
                                        <i class="bi bi-chevron-down"></i> <span class="toggle-text">展开</span>
                                    </button>
                                    <button type="button" class="btn btn-outline-success btn-sm" 
                                            onclick="addSheetConfig('{{ file.file_id }}')" 
                                            title="添加工作表配置">
                                        <i class="bi bi-plus-circle"></i> 添加工作表
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-2" id="sheets_body_{{ file.file_id }}" style="display: none;">
                            <div class="sheets-container" id="sheets_{{ file.file_id }}" style="max-height: 400px; overflow-y: auto;">
                                <!-- 工作表配置卡片将动态添加到这里 -->
                                {% for sheet in file.sheets %}
                                <div class="card mb-2 sheet-config-card" data-sheet-name="{{ sheet }}">
                                    <div class="card-body py-2">
                                        <div class="row align-items-center">
                                            <div class="col-md-3">
                                                <div class="form-check">
                                                    <input class="form-check-input sheet-enable" type="checkbox" 
                                                           id="sheet_{{ file.file_id }}_{{ loop.index }}" 
                                                           {% if loop.index == 1 %}checked{% endif %}>
                                                    <label class="form-check-label" for="sheet_{{ file.file_id }}_{{ loop.index }}">
                                                        <strong><i class="bi bi-file-earmark-spreadsheet"></i> {{ sheet }}</strong>
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label mb-0 small">表头行</label>
                                                <input type="number" class="form-control form-control-sm header-row" 
                                                       value="1" min="1">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label mb-0 small">数据源名称</label>
                                                <input type="text" class="form-control form-control-sm source-name" 
                                                       value="{{ file.original_filename.rsplit('.', 1)[0] }} - {{ sheet }}">
                                            </div>
                                            <div class="col-md-4 text-end">
                                                <button type="button" class="btn btn-outline-primary btn-sm" 
                                                        onclick="previewSheetConfig('{{ file.file_id }}', '{{ sheet }}', this)" 
                                                        title="预览此工作表">
                                                    <i class="bi bi-eye"></i> 预览
                                                </button>
                                                <button type="button" class="btn btn-outline-info btn-sm" 
                                                        onclick="detectSheetColumns('{{ file.file_id }}', '{{ sheet }}', this)" 
                                                        title="检测此工作表列类型">
                                                    <i class="bi bi-search"></i> 检测
                                                </button>
                                                {% if loop.index > 1 %}
                                                <button type="button" class="btn btn-outline-danger btn-sm" 
                                                        onclick="removeSheetConfig(this)" 
                                                        title="移除此工作表">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% if file.sheets|length > 5 %}
                            <div class="text-center mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> 工作表列表可滚动查看
                                </small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    
                    <!-- 数据清洗配置 -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <h6 class="text-primary"><i class="bi bi-funnel"></i> 数据清洗选项</h6>
                            <hr>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">基础清洗</h6>
                                </div>
                                <div class="card-body">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="removeEmptyRows">
                                        <label class="form-check-label" for="removeEmptyRows">
                                            去除空行
                                        </label>
                                    </div>
                                    
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="cleanNumeric">
                                        <label class="form-check-label" for="cleanNumeric">
                                            数值清洗 (去千分位、货币符号)
                                        </label>
                                    </div>
                                    
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="parseDates">
                                        <label class="form-check-label" for="parseDates">
                                            日期解析统一格式
                                        </label>
                                    </div>
                                    
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="removeDuplicates">
                                        <label class="form-check-label" for="removeDuplicates">
                                            去除重复行
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">高级选项</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">合并策略</label>
                                        <select class="form-select" id="mergeStrategy">
                                            <option value="outer">外连接 (保留所有列)</option>
                                            <option value="inner">内连接 (只保留共同列)</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">去重策略</label>
                                        <select class="form-select" id="keepStrategy">
                                            <option value="first">保留第一条</option>
                                            <option value="last">保留最后一条</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">关键列 (用于判断空行)</label>
                                        <input type="text" class="form-control" id="keyColumns" 
                                               placeholder="列名1,列名2... (留空表示检查所有列)">
                                        <small class="form-text text-muted">用逗号分隔多个列名</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 固定单元格配置 -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <h6 class="text-primary"><i class="bi bi-pin"></i> 固定单元格配置</h6>
                            <hr>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">
                                        固定单元格数据提取
                                        <button type="button" class="btn btn-sm btn-outline-success float-end" 
                                                onclick="addFixedCellRow()">
                                            <i class="bi bi-plus"></i> 添加配置
                                        </button>
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <small class="text-muted">
                                            <i class="bi bi-info-circle"></i>
                                            配置固定单元格位置，从中提取数据并添加为新列。支持多个文件的相同位置提取。
                                        </small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="enableFixedCells">
                                            <label class="form-check-label" for="enableFixedCells">
                                                启用固定单元格数据提取
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div id="fixed-cells-settings" style="display: none;">
                                        <div class="alert alert-info">
                                            <i class="bi bi-info-circle"></i> 
                                            配置通用规则后，系统会从<strong>所有文件</strong>中同名工作表提取固定单元格数据。
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-bordered">
                                                <thead>
                                                    <tr>
                                                        <th style="width: 20%;">工作表名称</th>
                                                        <th style="width: 15%;">单元格地址</th>
                                                        <th style="width: 20%;">列名称</th>
                                                        <th style="width: 20%;">预览值</th>
                                                        <th style="width: 15%;">操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="fixed-cells-table-body">
                                                    <!-- 动态添加的固定单元格配置行 -->
                                                </tbody>
                                            </table>
                                        </div>
                                        
                                        <div class="text-center">
                                            <button type="button" class="btn btn-outline-primary btn-sm" 
                                                    onclick="addFixedCellRow()">
                                                <i class="bi bi-plus"></i> 添加固定单元格
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div id="no-fixed-cells" class="text-center text-muted py-3">
                                        <i class="bi bi-grid"></i>
                                        <div>暂无固定单元格配置</div>
                                        <small>勾选"启用固定单元格数据提取"开始配置</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 列类型配置 -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <h6 class="text-primary"><i class="bi bi-gear"></i> 列类型配置</h6>
                            <hr>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">列配置管理</h6>
                                    <small class="text-muted">配置列类型、顺序、可见性和重命名</small>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <button type="button" class="btn btn-success btn-sm" onclick="loadColumnsForConfig()">
                                            <i class="bi bi-arrow-clockwise"></i> 自动加载列信息
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="addColumnConfigRow()">
                                            <i class="bi bi-plus"></i> 手动添加列
                                        </button>
                                        <button type="button" class="btn btn-outline-info btn-sm ms-2" onclick="resetColumnOrder()">
                                            <i class="bi bi-arrow-counterclockwise"></i> 重置顺序
                                        </button>
                                    </div>
                                    
                                    <div id="columnConfigContainer">
                                        <div class="table-responsive">
                                            <table class="table table-sm column-config-table" id="columnConfigTable">
                                                <thead>
                                                    <tr>
                                                        <th width="40">顺序</th>
                                                        <th width="40">显示</th>
                                                        <th>原列名</th>
                                                        <th>显示名称</th>
                                                        <th>数据类型</th>
                                                        <th width="100">操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="columnConfigBody">
                                                    <!-- 动态内容 -->
                                                </tbody>
                                            </table>
                                        </div>
                                        <small class="form-text text-muted">
                                            <strong>说明：</strong><br>
                                            • <strong>顺序</strong> - 拖拽数字或使用上下箭头调整列顺序<br>
                                            • <strong>显示</strong> - 控制该列是否在最终结果中显示<br>
                                            • <strong>显示名称</strong> - 导出时使用的列名（留空则使用原列名）<br>
                                            • <strong>数据类型</strong> - auto(自动)、text(文本)、number(数值)、date(日期)、skip(跳过)
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 导出配置 -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <h6 class="text-primary"><i class="bi bi-download"></i> 导出设置</h6>
                            <hr>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">导出格式</label>
                            <select class="form-select" id="exportFormat">
                                <option value="xlsx">Excel (.xlsx)</option>
                                <option value="csv">CSV (.csv)</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">文件名</label>
                            <input type="text" class="form-control" id="exportFilename" 
                                   value="merged_data" placeholder="merged_data">
                            <small class="form-text text-muted">不需要包含扩展名</small>
                        </div>
                    </div>
                    
                    <!-- 操作按钮 -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <hr>
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" class="btn btn-secondary" onclick="history.back()">
                                    <i class="bi bi-arrow-left"></i> 返回
                                </button>
                                <button type="button" class="btn btn-info" onclick="previewMergedData()">
                                    <i class="bi bi-eye"></i> 预览合并结果
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-play"></i> 开始合并
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 复制第一个文件配置模态框 -->
<div class="modal fade" id="copyFirstConfigModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-files"></i> 复制第一个文件配置
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 
                    将第一个文件的配置应用到其他文件。
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">第一个文件：<span id="firstFileNameDisplay" class="text-primary"></span></label>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">选择要复制的配置项：</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="copySheetSelect" checked>
                        <label class="form-check-label" for="copySheetSelect">
                            工作表选择
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="copyHeaderRow" checked>
                        <label class="form-check-label" for="copyHeaderRow">
                            表头行号
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="copySourceName">
                        <label class="form-check-label" for="copySourceName">
                            数据源名称格式（将使用第一个文件的命名规则）
                        </label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">应用到：</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="copyTargetScope" id="copyToAll" value="all" checked>
                        <label class="form-check-label" for="copyToAll">
                            所有其他文件 (<span id="otherFilesCount">0</span> 个)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="copyTargetScope" id="copyToSelected" value="selected">
                        <label class="form-check-label" for="copyToSelected">
                            选择特定文件
                        </label>
                    </div>
                </div>
                
                <div id="copyTargetFilesList" class="mb-3" style="display: none;">
                    <label class="form-label">选择目标文件：</label>
                    <div id="copyTargetFilesContainer" style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px;">
                        <!-- 动态生成文件列表 -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="executeCopyFirstConfig()">
                    <i class="bi bi-check-lg"></i> 应用配置
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 配置管理模态框 -->
<div class="modal fade" id="configManagerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-gear"></i> 配置管理
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- 缓存配置管理 -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-clock-history"></i> 历史配置
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <label class="form-label">选择历史配置</label>
                                        <select class="form-select" id="cachedConfigSelect">
                                            <option value="">选择要应用的历史配置...</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">&nbsp;</label>
                                        <div class="d-grid gap-2">
                                            <button type="button" class="btn btn-success btn-sm" onclick="applyCachedConfig()">
                                                <i class="bi bi-arrow-clockwise"></i> 应用配置
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <label class="form-label">保存当前配置</label>
                                        <input type="text" class="form-control" id="configCacheName" placeholder="输入配置名称...">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">&nbsp;</label>
                                        <button type="button" class="btn btn-primary btn-sm w-100" onclick="saveCurrentConfigToCache()">
                                            <i class="bi bi-save"></i> 保存配置
                                        </button>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">&nbsp;</label>
                                        <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="clearCachedConfigs()">
                                            <i class="bi bi-trash"></i> 清空缓存
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-download"></i> 导出配置
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="small text-muted">将当前所有配置导出为JSON文件，可用于备份或复用。</p>
                                <button type="button" class="btn btn-info w-100" onclick="doExportConfig()">
                                    <i class="bi bi-download"></i> 导出配置文件
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-upload"></i> 导入配置
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="small text-muted">从之前导出的JSON配置文件中加载配置。</p>
                                <input type="file" class="form-control mb-2" id="configFileInput" accept=".json">
                                <button type="button" class="btn btn-success w-100" onclick="doImportConfig()">
                                    <i class="bi bi-upload"></i> 导入配置文件
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-list"></i> 配置预览
                                </h6>
                            </div>
                            <div class="card-body">
                                <pre id="configPreview" class="bg-light p-2" style="max-height: 200px; overflow-y: auto;">
点击"预览当前配置"查看当前配置内容
                                </pre>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="previewCurrentConfig()">
                                    预览当前配置
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 预览模态框 -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-eye"></i> 数据预览
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="previewContent">
                <!-- 预览内容 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 列类型检测模态框 -->
<div class="modal fade" id="columnTypesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-search"></i> 列类型检测结果
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="columnTypesContent">
                <!-- 列类型内容 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// 表单提交处理
document.getElementById('configForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // 收集配置数据
    const config = collectConfiguration();
    
    if (!config.file_configs || config.file_configs.length === 0) {
        alert('请至少选择一个文件');
        return;
    }
    
    // 提交任务
    submitMergeTask(config);
});

// 收集配置数据
function collectConfiguration() {
    const fileConfigs = [];
    const cleaningOptions = {};
    const exportOptions = {};
    
    // 收集文件配置（遍历所有文件容器）
    document.querySelectorAll('.file-config-container').forEach(fileContainer => {
        const fileCheckbox = fileContainer.querySelector('.file-enable');
        if (!fileCheckbox.checked) return;
        
        const fileId = fileContainer.dataset.fileId;
        
        // 收集该文件下所有启用的工作表配置
        fileContainer.querySelectorAll('.sheet-config-card').forEach(sheetCard => {
            const sheetCheckbox = sheetCard.querySelector('.sheet-enable');
            if (!sheetCheckbox.checked) return;
            
            const sheetName = sheetCard.dataset.sheetName;
            const headerRow = parseInt(sheetCard.querySelector('.header-row').value) - 1; // 转为0-based
            const sourceName = sheetCard.querySelector('.source-name').value;
            
            fileConfigs.push({
                file_id: fileId,
                sheet_name: sheetName,
                header_row: headerRow,
                source_name: sourceName
            });
        });
    });
    
    // 收集清洗选项
    cleaningOptions.remove_empty_rows = document.getElementById('removeEmptyRows').checked;
    cleaningOptions.clean_numeric = document.getElementById('cleanNumeric').checked;
    cleaningOptions.parse_dates = document.getElementById('parseDates').checked;
    cleaningOptions.remove_duplicates = document.getElementById('removeDuplicates').checked;
    cleaningOptions.merge_strategy = document.getElementById('mergeStrategy').value;
    cleaningOptions.keep_strategy = document.getElementById('keepStrategy').value;
    
    const keyColumns = document.getElementById('keyColumns').value.trim();
    if (keyColumns) {
        cleaningOptions.key_columns = keyColumns.split(',').map(col => col.trim());
    }
    
    // 收集列类型配置
    const columnTypes = {};
    const columnOrder = [];
    const columnNames = {};
    const hiddenColumns = new Set();
    
    document.querySelectorAll('#columnConfigBody tr').forEach((row, index) => {
        const originalName = row.querySelector('.original-column-name').value.trim();
        const displayName = row.querySelector('.display-column-name').value.trim();
        const columnType = row.querySelector('.column-type').value;
        const isVisible = row.querySelector('.column-visible').checked;
        
        if (originalName) {
            // 记录列顺序
            columnOrder.push(originalName);
            
            // 记录列类型（如果不是auto）
            if (columnType !== 'auto') {
                columnTypes[originalName] = columnType;
            }
            
            // 记录显示名称（如果与原名不同）
            if (displayName && displayName !== originalName) {
                columnNames[originalName] = displayName;
            }
            
            // 记录隐藏列
            if (!isVisible) {
                hiddenColumns.add(originalName);
            }
        }
    });
    
    if (Object.keys(columnTypes).length > 0) {
        cleaningOptions.column_types = columnTypes;
    }
    
    if (columnOrder.length > 0) {
        cleaningOptions.column_order = columnOrder;
    }
    
    if (Object.keys(columnNames).length > 0) {
        cleaningOptions.column_names = columnNames;
    }
    
    if (hiddenColumns.size > 0) {
        cleaningOptions.hidden_columns = Array.from(hiddenColumns);
    }
    
    // 收集固定单元格配置
    const fixedCellsEnabled = document.getElementById('enableFixedCells')?.checked || false;
    if (fixedCellsEnabled) {
        const fixedCellsRules = [];
        document.querySelectorAll('#fixed-cells-table-body tr').forEach(row => {
            const sheetName = row.querySelector('.fixed-cell-sheet-input')?.value?.trim();
            const cellAddress = row.querySelector('.fixed-cell-address-input')?.value?.trim().toUpperCase();
            const newColumnName = row.querySelector('.fixed-cell-column-name')?.value?.trim();
                
            if (sheetName && cellAddress && newColumnName) {
                // 验证单元格地址格式
                if (cellAddress.match(/^[A-Z]+[0-9]+$/)) {
                    fixedCellsRules.push({
                        sheet_name: sheetName,
                        cell_address: cellAddress,
                        column_name: newColumnName
                    });
                }
            }
        });
            
        if (fixedCellsRules.length > 0) {
            cleaningOptions.fixed_cells_rules = fixedCellsRules;
        }
    }

    // 收集单元格截取配置（保持向后兼容）
    const cellExtractionEnabled = document.getElementById('enableCellExtraction')?.checked || false;
    if (cellExtractionEnabled) {
        const cellExtractionRules = [];
        document.querySelectorAll('#cellExtractionBody tr').forEach(row => {
            const fileId = row.querySelector('.extraction-file-select')?.value;
            const sheetName = row.querySelector('.extraction-sheet-input')?.value?.trim();
            const rowNum = row.querySelector('.extraction-row-input')?.value?.trim();
            const colNum = row.querySelector('.extraction-col-input')?.value?.trim();
            const newColumnName = row.querySelector('.extraction-column-name')?.value?.trim();
            const dataType = row.querySelector('.extraction-data-type')?.value;
            const description = row.querySelector('.extraction-description')?.value?.trim();
                
            if (fileId && rowNum && colNum && newColumnName) {
                cellExtractionRules.push({
                    file_id: fileId,
                    sheet_name: sheetName || null,
                    row_number: parseInt(rowNum),
                    column_number: parseInt(colNum),
                    new_column_name: newColumnName,
                    data_type: dataType,
                    description: description
                });
            }
        });
            
        if (cellExtractionRules.length > 0) {
            cleaningOptions.cell_extraction_rules = cellExtractionRules;
        }
    }
    
    // 收集导出选项
    exportOptions.format = document.getElementById('exportFormat').value;
    exportOptions.filename = document.getElementById('exportFilename').value || 'merged_data';
    
    return {
        file_configs: fileConfigs,
        cleaning_options: cleaningOptions,
        export_options: exportOptions
    };
}

// 提交合并任务
function submitMergeTask(config) {
    // 显示提交状态
    const submitBtn = document.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 提交中...';
    
    fetch('/submit_task', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = `/task/${data.task_id}`;
        } else {
            alert('提交失败：' + data.error);
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    })
    .catch(error => {
        alert('提交失败：' + error.message);
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

// 文件启用/禁用处理
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('file-enable')) {
        const fileContainer = e.target.closest('.file-config-container');
        if (!fileContainer) return;
        
        const sheetsContainer = fileContainer.querySelector('.sheets-container');
        if (!sheetsContainer) return;
        
        if (e.target.checked) {
            fileContainer.classList.remove('opacity-50');
            sheetsContainer.querySelectorAll('input, button').forEach(el => {
                if (el) el.disabled = false;
            });
        } else {
            fileContainer.classList.add('opacity-50');
            sheetsContainer.querySelectorAll('input, button').forEach(el => {
                if (el) el.disabled = true;
            });
        }
    }
});
function displayPreviewData(data, title = '数据预览') {
    document.querySelector('#previewModal .modal-title').innerHTML = 
        `<i class="bi bi-eye"></i> ${title}`;
    
    if (!data || !data.data || data.data.length === 0) {
        document.getElementById('previewContent').innerHTML = 
            '<div class="alert alert-warning">没有数据可预览</div>';
        return;
    }
    
    const columns = data.columns;
    const rows = data.data;
    
    let html = `
        <div class="mb-2">
            <small class="text-muted">
                共 ${data.total_rows} 行，${data.total_columns} 列
            </small>
        </div>
        <div class="table-responsive">
            <style>
                .preview-table {
                    white-space: nowrap;
                    table-layout: fixed;
                    width: 100%;
                }
                .preview-table th, .preview-table td {
                    max-width: 200px;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                    padding: 4px 8px;
                    border: 1px solid #dee2e6;
                }
                .preview-table th {
                    position: sticky;
                    top: 0;
                    background-color: #f8f9fa;
                    z-index: 10;
                    font-weight: 600;
                }
                .preview-table td:hover {
                    background-color: #f8f9fa;
                    cursor: pointer;
                    position: relative;
                }
                .preview-table td:hover::after {
                    content: attr(title);
                    position: absolute;
                    background: #333;
                    color: white;
                    padding: 4px 8px;
                    border-radius: 4px;
                    white-space: normal;
                    z-index: 1000;
                    top: -5px;
                    left: 0;
                    max-width: 300px;
                    word-wrap: break-word;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                }
            </style>
            <table class="table table-sm table-bordered preview-table">
                <thead class="table-light">
                    <tr>
    `;
    
    columns.forEach((col, index) => {
        const width = Math.max(120, Math.min(200, col.length * 10 + 50));
        html += `<th style="width: ${width}px;" title="${col}">${col}</th>`;
    });
    html += '</tr></thead><tbody>';
    
    rows.slice(0, 50).forEach(row => {  // 最多显示50行
        html += '<tr>';
        columns.forEach(col => {
            const value = String(row[col] || '');
            const displayValue = value.length > 25 ? value.substring(0, 25) + '...' : value;
            html += `<td title="${value.replace(/"/g, '&quot;')}">${displayValue}</td>`;
        });
        html += '</tr>';
    });
    
    html += '</tbody></table></div>';
    
    if (rows.length > 50) {
        html += '<div class="alert alert-info">只显示前50行数据</div>';
    }
    
    document.getElementById('previewContent').innerHTML = html;
}

// 显示列类型
function displayColumnTypes(columnTypes, columns) {
    let html = `
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>列名</th>
                        <th>检测类型</th>
                        <th>建议操作</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    columns.forEach(col => {
        const type = columnTypes[col] || 'unknown';
        let typeIcon = '';
        let suggestion = '';
        
        switch(type) {
            case 'numeric':
                typeIcon = '<i class="bi bi-123 text-primary"></i> 数值';
                suggestion = '建议开启数值清洗';
                break;
            case 'date':
                typeIcon = '<i class="bi bi-calendar text-success"></i> 日期';
                suggestion = '建议开启日期解析';
                break;
            case 'text':
                typeIcon = '<i class="bi bi-fonts text-info"></i> 文本';
                suggestion = '无需特殊处理';
                break;
            default:
                typeIcon = '<i class="bi bi-question text-muted"></i> 未知';
                suggestion = '请手动确认';
        }
        
        html += `
            <tr>
                <td><code>${col}</code></td>
                <td>${typeIcon}</td>
                <td><small class="text-muted">${suggestion}</small></td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    
    document.getElementById('columnTypesContent').innerHTML = html;
}

// 预览合并结果
function previewMergedData() {
    // 收集配置数据
    const config = collectConfiguration();
    
    if (!config.file_configs || config.file_configs.length === 0) {
        alert('请至少选择一个文件进行预览');
        return;
    }
    
    // 显示加载状态
    const previewBtn = document.querySelector('button[onclick="previewMergedData()"]');
    const originalText = previewBtn.innerHTML;
    previewBtn.disabled = true;
    previewBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 预览中...';
    
    fetch('/preview_merge', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            file_configs: config.file_configs,
            cleaning_options: config.cleaning_options
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showPreviewModal(data.preview_data, data.stats);
        } else {
            alert('预览失败: ' + (data.error || '未知错误'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('预览失败: ' + error.message);
    })
    .finally(() => {
        previewBtn.disabled = false;
        previewBtn.innerHTML = originalText;
    });
}

// 显示预览模态框
function showPreviewModal(previewData, stats) {
    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    
    // 构建配置应用信息
    const appliedConfigs = stats.applied_configurations;
    let configInfo = '';
    if (appliedConfigs.column_order || appliedConfigs.column_names || appliedConfigs.hidden_columns) {
        configInfo += '<br>• 列配置: ';
        const configParts = [];
        if (appliedConfigs.column_order) configParts.push('自定义顺序');
        if (appliedConfigs.column_names) configParts.push('重命名');
        if (appliedConfigs.hidden_columns) configParts.push('隐藏列');
        configInfo += configParts.join(', ');
    }
    
    let cleaningInfo = '';
    if (appliedConfigs.clean_numeric || appliedConfigs.parse_dates || appliedConfigs.remove_duplicates) {
        cleaningInfo += '<br>• 数据清洗: ';
        const cleaningParts = [];
        if (appliedConfigs.clean_numeric) cleaningParts.push('数值清洗');
        if (appliedConfigs.parse_dates) cleaningParts.push('日期解析');
        if (appliedConfigs.remove_duplicates) cleaningParts.push('去重');
        cleaningInfo += cleaningParts.join(', ');
    }
    
    let html = `
        <div class="alert alert-info">
            <strong>预览信息：</strong><br>
            • 合并策略: ${previewData.strategy === 'outer' ? '外连接 (保留所有列)' : '内连接 (只保留共同列)'}<br>
            • 输入文件: ${stats.input_files} 个${previewData.is_partial_preview ? ` (仅显示前${previewData.preview_files}个文件数据)` : ''}<br>
            • 预计总行数: ${stats.estimated_total_rows} 行<br>
            • 最终列数: ${stats.total_columns} 列${configInfo}${cleaningInfo}<br>
            • 显示前 ${previewData.preview_rows} 行数据
            ${previewData.is_partial_preview ? '<br><span class="badge bg-warning text-dark">⚡ 快速预览模式：为提高速度，仅加载前3个文件的部分数据</span>' : ''}
        </div>
        
        <div class="table-responsive">
            <style>
                .merge-preview-table {
                    white-space: nowrap;
                    table-layout: fixed;
                    width: 100%;
                }
                .merge-preview-table th {
                    max-width: 200px;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                    padding: 4px 8px;
                    border: 1px solid #dee2e6;
                    text-align: center;
                    position: sticky;
                    top: 0;
                    background-color: #343a40;
                    color: white;
                    z-index: 10;
                    font-weight: 600;
                }
                .merge-preview-table td {
                    max-width: 200px;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                    padding: 4px 12px 4px 8px;  /* 右侧留12px空间 */
                    border: 1px solid #dee2e6;
                    text-align: center;  /* 默认居中，数字会被覆盖 */
                }
                .merge-preview-table td.number-cell {
                    text-align: right;  /* 数字靠右 */
                    padding-right: 12px;  /* 右侧留出空间 */
                }
                .merge-preview-table td:hover {
                    background-color: #f8f9fa;
                    cursor: pointer;
                    position: relative;
                }
                .merge-preview-table td:hover::after {
                    content: attr(title);
                    position: absolute;
                    background: #333;
                    color: white;
                    padding: 4px 8px;
                    border-radius: 4px;
                    white-space: normal;
                    z-index: 1000;
                    top: -5px;
                    left: 50%;
                    transform: translateX(-50%);
                    max-width: 300px;
                    word-wrap: break-word;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                }
            </style>
            <table class="table table-sm table-striped merge-preview-table">
                <thead class="table-dark">
                    <tr>
    `;
    
    // 添加表头
    previewData.columns.forEach((col, index) => {
        const width = Math.max(120, Math.min(200, col.length * 10 + 50));
        html += `<th style="width: ${width}px;" title="${col}">${col}</th>`;
    });
    html += '</tr></thead><tbody>';
    
    // 添加数据行
    previewData.data.forEach(row => {
        html += '<tr>';
        row.forEach((cell, index) => {
            const cellValue = cell !== null && cell !== undefined ? String(cell) : '';
            const displayValue = cellValue.length > 25 ? cellValue.substring(0, 25) + '...' : cellValue;
            
            // 判断是否为数字类型
            const isNumber = typeof cell === 'number' || (!isNaN(cell) && cell !== '' && cell !== null);
            const cellClass = isNumber ? 'number-cell' : '';
            
            html += `<td class="${cellClass}" title="${cellValue.replace(/"/g, '&quot;')}">${displayValue}</td>`;
        });
        html += '</tr>';
    });
    
    html += '</tbody></table></div>';
    
    if (previewData.total_rows > previewData.preview_rows) {
        html += `
            <div class="alert alert-warning mt-3">
                <i class="bi bi-info-circle"></i> 
                只显示前 ${previewData.preview_rows} 行，完整数据共 ${previewData.total_rows} 行
            </div>
        `;
    }
    
    // 如果应用了配置，显示提示
    if (configInfo || cleaningInfo) {
        html += `
            <div class="alert alert-success mt-3">
                <i class="bi bi-check-circle"></i> 
                <strong>已应用用户配置</strong> - 预览结果反映了您的列配置和数据清洗设置
            </div>
        `;
    }
    
    document.getElementById('previewContent').innerHTML = html;
    modal.show();
}

// 文件启用/禁用处理
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('file-enable')) {
        const fileCard = e.target.closest('.file-config');
        const inputs = fileCard.querySelectorAll('select, input:not(.file-enable)');
        
        inputs.forEach(input => {
            input.disabled = !e.target.checked;
        });
        
        if (e.target.checked) {
            fileCard.classList.remove('opacity-50');
        } else {
            fileCard.classList.add('opacity-50');
        }
    }
});

// 加载列信息用于配置
function loadColumnsForConfig() {
    const fileConfigs = [];
    
    // 收集已启用的文件和工作表配置
    document.querySelectorAll('.file-config-container').forEach(fileContainer => {
        const fileCheckbox = fileContainer.querySelector('.file-enable');
        if (!fileCheckbox.checked) return;
        
        const fileId = fileContainer.dataset.fileId;
        
        // 收集该文件下所有启用的工作表
        fileContainer.querySelectorAll('.sheet-config-card').forEach(sheetCard => {
            const sheetCheckbox = sheetCard.querySelector('.sheet-enable');
            if (!sheetCheckbox.checked) return;
            
            const sheetName = sheetCard.dataset.sheetName;
            const headerRow = parseInt(sheetCard.querySelector('.header-row').value) - 1;
            
            fileConfigs.push({
                file_id: fileId,
                sheet_name: sheetName,
                header_row: headerRow
            });
        });
    });
    
    if (fileConfigs.length === 0) {
        alert('请先启用至少一个工作表');
        return;
    }
    
    // 显示加载状态
    const loadBtn = document.querySelector('button[onclick="loadColumnsForConfig()"]');
    const originalText = loadBtn.innerHTML;
    loadBtn.disabled = true;
    loadBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 加载中...';
    
    fetch('/get_merged_columns', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({file_configs: fileConfigs})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            populateColumnConfigTable(data.columns);
        } else {
            alert('加载列信息失败: ' + (data.error || '未知错误'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('加载列信息失败: ' + error.message);
    })
    .finally(() => {
        loadBtn.disabled = false;
        loadBtn.innerHTML = originalText;
    });
}

// 填充列配置表格
function populateColumnConfigTable(columns) {
    const tbody = document.getElementById('columnConfigBody');
    tbody.innerHTML = '';
    
    columns.forEach((column, index) => {
        addColumnConfigRow(column.name, column.name, column.suggested_type || 'auto', true, index + 1);
    });
    
    // 启用拖拽排序
    enableColumnSorting();
}

// 添加列配置行
function addColumnConfigRow(originalName = '', displayName = '', columnType = 'auto', isVisible = true, order = null) {
    const tbody = document.getElementById('columnConfigBody');
    const row = document.createElement('tr');
    
    if (order === null) {
        order = tbody.children.length + 1;
    }
    
    row.innerHTML = `
        <td>
            <div class="d-flex align-items-center">
                <input type="number" class="form-control form-control-sm column-order" 
                       value="${order}" min="1" style="width: 60px;" onchange="updateColumnOrder()">
                <div class="ms-2 drag-handle" style="cursor: move; padding: 4px;" title="拖拽排序">
                    <i class="bi bi-grip-vertical text-muted"></i>
                </div>
            </div>
        </td>
        <td>
            <input type="checkbox" class="form-check-input column-visible" ${isVisible ? 'checked' : ''} onchange="toggleColumnVisibility(this)">
        </td>
        <td>
            <input type="text" class="form-control form-control-sm original-column-name" 
                   value="${originalName}" placeholder="原列名" readonly>
        </td>
        <td>
            <input type="text" class="form-control form-control-sm display-column-name" 
                   value="${displayName}" placeholder="显示名称">
        </td>
        <td>
            <select class="form-select form-select-sm column-type">
                <option value="auto" ${columnType === 'auto' ? 'selected' : ''}>自动检测</option>
                <option value="text" ${columnType === 'text' ? 'selected' : ''}>文本</option>
                <option value="number" ${columnType === 'number' ? 'selected' : ''}>数值</option>
                <option value="date" ${columnType === 'date' ? 'selected' : ''}>日期</option>
                <option value="skip" ${columnType === 'skip' ? 'selected' : ''}>跳过</option>
            </select>
        </td>
        <td>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeColumnConfigRow(this)">
                <i class="bi bi-trash"></i>
            </button>
        </td>
    `;    
    tbody.appendChild(row);
    
    // 如果列不可见，应用视觉样式
    if (!isVisible) {
        toggleColumnVisibility(row.querySelector('.column-visible'));
    }
}

// 删除列配置行（直接隐藏）
function removeColumnConfigRow(button) {
    const row = button.closest('tr');
    const visibilityCheckbox = row.querySelector('.column-visible');
    
    // 直接隐藏列（不显示提示）
    visibilityCheckbox.checked = false;
    
    // 添加视觉提示表示该列已隐藏
    row.style.opacity = '0.5';
    row.style.backgroundColor = '#f8f9fa';
    row.title = '此列已隐藏，不会在最终结果中显示';
    
    // 更新按钮文本和颜色
    const deleteBtn = row.querySelector('.btn-outline-danger');
    if (deleteBtn) {
        deleteBtn.className = 'btn btn-outline-success btn-sm';
        deleteBtn.innerHTML = '<i class="bi bi-eye"></i>';
        deleteBtn.title = '点击显示此列';
        deleteBtn.onclick = function() { showColumnConfigRow(this); };
    }
}

// 显示列配置行（恢复隐藏的列）
function showColumnConfigRow(button) {
    const row = button.closest('tr');
    const visibilityCheckbox = row.querySelector('.column-visible');
    
    // 恢复可见性
    visibilityCheckbox.checked = true;
    
    // 恢复视觉样式
    row.style.opacity = '1';
    row.style.backgroundColor = '';
    row.title = '';
    
    // 恢复按钮
    const showBtn = row.querySelector('.btn-outline-success');
    if (showBtn) {
        showBtn.className = 'btn btn-outline-danger btn-sm';
        showBtn.innerHTML = '<i class="bi bi-trash"></i>';
        showBtn.title = '删除/隐藏此列';
        showBtn.onclick = function() { removeColumnConfigRow(this); };
    }
}

// 切换列可见性
function toggleColumnVisibility(checkbox) {
    const row = checkbox.closest('tr');
    const columnName = row.querySelector('.original-column-name').value || row.querySelector('.display-column-name').value || '未命名列';
    const deleteBtn = row.querySelector('.btn-outline-danger, .btn-outline-success');
    
    if (checkbox.checked) {
        // 显示列
        row.style.opacity = '1';
        row.style.backgroundColor = '';
        row.title = '';
        
        // 恢复删除按钮
        if (deleteBtn) {
            deleteBtn.className = 'btn btn-outline-danger btn-sm';
            deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
            deleteBtn.title = '删除/隐藏此列';
            deleteBtn.onclick = function() { removeColumnConfigRow(this); };
        }
    } else {
        // 隐藏列
        row.style.opacity = '0.5';
        row.style.backgroundColor = '#f8f9fa';
        row.title = '此列已隐藏，不会在最终结果中显示';
        
        // 更改为显示按钮
        if (deleteBtn) {
            deleteBtn.className = 'btn btn-outline-success btn-sm';
            deleteBtn.innerHTML = '<i class="bi bi-eye"></i>';
            deleteBtn.title = '点击显示此列';
            deleteBtn.onclick = function() { showColumnConfigRow(this); };
        }
    }
}

// 更新列顺序号码
function updateColumnOrder() {
    document.querySelectorAll('#columnConfigBody tr').forEach((row, index) => {
        row.querySelector('.column-order').value = index + 1;
    });
}

// 重置列顺序
function resetColumnOrder() {
    const tbody = document.getElementById('columnConfigBody');
    const rows = Array.from(tbody.children);
    
    // 按原列名字母顺序排序
    rows.sort((a, b) => {
        const nameA = a.querySelector('.original-column-name').value;
        const nameB = b.querySelector('.original-column-name').value;
        return nameA.localeCompare(nameB);
    });
    
    // 重新插入排序后的行
    rows.forEach(row => tbody.appendChild(row));
    updateColumnOrder();
}

// 启用列拖拽排序
function enableColumnSorting() {
    const tbody = document.getElementById('columnConfigBody');
    if (!tbody) return;
    
    // 为每个表格行添加拖拽功能
    tbody.querySelectorAll('tr').forEach(addDragToRow);
    
    // 监听新添加的行
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === 1 && node.tagName === 'TR') {
                    addDragToRow(node);
                }
            });
        });
    });
    
    observer.observe(tbody, { childList: true });
    
    // 添加表格级别的拖拽处理
    tbody.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    });
    
    tbody.addEventListener('drop', function(e) {
        e.preventDefault();
        // 确保顺序更新
        setTimeout(() => {
            updateColumnOrder();
        }, 10);
    });
}

// 节流函数
function throttle(func, delay) {
    let timeoutId;
    let lastExecTime = 0;
    return function (...args) {
        const currentTime = Date.now();
        
        if (currentTime - lastExecTime > delay) {
            func.apply(this, args);
            lastExecTime = currentTime;
        } else {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
                func.apply(this, args);
                lastExecTime = Date.now();
            }, delay - (currentTime - lastExecTime));
        }
    };
}

// 为单个行添加拖拽功能
function addDragToRow(row) {
    // 设置行为可拖拽
    row.draggable = true;
    
    let placeholder = null;
    
    // 拖拽开始事件
    row.addEventListener('dragstart', function(e) {
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', '');
        
        // 添加拖拽样式
        row.classList.add('dragging');
        
        // 创建占位符
        placeholder = document.createElement('tr');
        placeholder.className = 'drag-placeholder';
        placeholder.innerHTML = '<td colspan="6" style="height: 3px; background: linear-gradient(90deg, #007bff, #0056b3); border: none; padding: 0; border-radius: 2px;"></td>';
    });
    
    // 拖拽结束事件
    row.addEventListener('dragend', function(e) {
        row.classList.remove('dragging');
        
        // 移除占位符
        if (placeholder && placeholder.parentNode) {
            placeholder.parentNode.removeChild(placeholder);
        }
        
        // 清除所有拖拽目标样式
        document.querySelectorAll('.drag-target').forEach(el => {
            el.classList.remove('drag-target');
        });
        
        placeholder = null;
    });
    
    // 拖拽经过事件
    row.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        
        const draggingRow = document.querySelector('.dragging');
        if (!draggingRow || draggingRow === row || !placeholder) {
            return;
        }
        
        const tbody = row.parentNode;
        
        // 移除之前的占位符
        if (placeholder.parentNode) {
            placeholder.parentNode.removeChild(placeholder);
        }
        
        // 计算鼠标相对于目标行的位置
        const rect = row.getBoundingClientRect();
        const midpoint = rect.top + rect.height / 2;
        
        if (e.clientY < midpoint) {
            // 插入到目标行之前
            tbody.insertBefore(placeholder, row);
        } else {
            // 插入到目标行之后
            const nextSibling = row.nextElementSibling;
            if (nextSibling) {
                tbody.insertBefore(placeholder, nextSibling);
            } else {
                tbody.appendChild(placeholder);
            }
        }
    });
    
    // 拖拽进入事件
    row.addEventListener('dragenter', function(e) {
        e.preventDefault();
        if (!row.classList.contains('dragging')) {
            row.classList.add('drag-target');
        }
    });
    
    // 拖拽离开事件  
    row.addEventListener('dragleave', function(e) {
        if (!row.contains(e.relatedTarget)) {
            row.classList.remove('drag-target');
        }
    });
    
    // 拖拽放置事件
    row.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const draggingRow = document.querySelector('.dragging');
        if (!draggingRow || draggingRow === row) {
            return;
        }
        
        row.classList.remove('drag-target');
        
        // 计算鼠标相对于目标行的位置
        const tbody = row.parentNode;
        const rect = row.getBoundingClientRect();
        const midpoint = rect.top + rect.height / 2;
        
        // 获取原始位置用于调试
        const allRows = Array.from(tbody.children);
        const originalDragIndex = allRows.indexOf(draggingRow);
        const targetRowIndex = allRows.indexOf(row);
        
        // 执行插入操作
        if (e.clientY < midpoint) {
            // 插入到目标行之前
            tbody.insertBefore(draggingRow, row);
            console.log(`向上拖拽: 从第${originalDragIndex + 1}行移动到第${targetRowIndex + 1}行之前`);
        } else {
            // 插入到目标行之后
            const nextSibling = row.nextElementSibling;
            if (nextSibling) {
                tbody.insertBefore(draggingRow, nextSibling);
                console.log(`向下拖拽: 从第${originalDragIndex + 1}行移动到第${targetRowIndex + 1}行之后`);
            } else {
                tbody.appendChild(draggingRow);
                console.log(`移动到最后: 从第${originalDragIndex + 1}行移动到最后一位`);
            }
        }
        
        // 更新顺序号并显示提示
        updateColumnOrder();
        showToast('列顺序已更新', 'success');
        
        // 输出移动后的位置
        const newRows = Array.from(tbody.children);
        const newDragIndex = newRows.indexOf(draggingRow);
        console.log(`移动结果: 现在在第${newDragIndex + 1}行`);
    });
}

// 显示Toast提示
function showToast(message, type = 'info') {
    // 创建Toast容器（如果不存在）
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    // 创建Toast元素
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'primary'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    // 显示Toast
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, {
        autohide: true,
        delay: 2000
    });
    
    toast.show();
    
    // Toast隐藏后删除元素
    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
}

// 获取拖拽位置的下一个元素（保留以备用）
function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('tr:not(.dragging)')];
    
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

// ================ 复制第一个文件配置功能 ================

// 显示复制配置对话框
function copyFirstFileConfig() {
    const fileContainers = document.querySelectorAll('.file-config-container');
    
    if (fileContainers.length < 2) {
        alert('只有一个文件，无需复制配置');
        return;
    }
    
    const firstFile = fileContainers[0];
    const firstFileLabel = firstFile.querySelector('label.fw-bold');
    const firstFileName = firstFileLabel ? firstFileLabel.textContent.trim().split('(')[0].trim() : '第一个文件';
    
    // 设置第一个文件名称显示
    document.getElementById('firstFileNameDisplay').textContent = firstFileName;
    
    // 设置其他文件数量
    document.getElementById('otherFilesCount').textContent = fileContainers.length - 1;
    
    // 生成目标文件列表
    const targetContainer = document.getElementById('copyTargetFilesContainer');
    targetContainer.innerHTML = '';
    
    for (let i = 1; i < fileContainers.length; i++) {
        const targetFile = fileContainers[i];
        const fileId = targetFile.dataset.fileId;
        const label = targetFile.querySelector('label.fw-bold');
        const fileName = label ? label.textContent.trim().split('(')[0].trim() : `文件 ${i + 1}`;
        
        const div = document.createElement('div');
        div.className = 'form-check';
        div.innerHTML = `
            <input class="form-check-input copy-target-file" type="checkbox" value="${fileId}" id="copy_target_${fileId}" checked>
            <label class="form-check-label" for="copy_target_${fileId}">
                ${fileName}
            </label>
        `;
        targetContainer.appendChild(div);
    }
    
    // 监听目标范围选择
    document.getElementById('copyToAll').addEventListener('change', function() {
        if (this.checked) {
            document.getElementById('copyTargetFilesList').style.display = 'none';
        }
    });
    
    document.getElementById('copyToSelected').addEventListener('change', function() {
        if (this.checked) {
            document.getElementById('copyTargetFilesList').style.display = 'block';
        }
    });
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('copyFirstConfigModal'));
    modal.show();
}

// 执行复制配置
function executeCopyFirstConfig() {
    const fileContainers = document.querySelectorAll('.file-config-container');
    const firstFile = fileContainers[0];
    
    // 获取选中的配置项
    const copySheet = document.getElementById('copySheetSelect')?.checked || false;
    const copyHeader = document.getElementById('copyHeaderRow')?.checked || false;
    const copySourceName = document.getElementById('copySourceName')?.checked || false;
    
    if (!copySheet && !copyHeader && !copySourceName) {
        alert('请至少选择一个要复制的配置项');
        return;
    }
    
    // 获取目标文件范围
    const targetScope = document.querySelector('input[name="copyTargetScope"]:checked')?.value || 'all';
    let targetFiles = [];
    
    if (targetScope === 'all') {
        // 所有其他文件
        for (let i = 1; i < fileContainers.length; i++) {
            targetFiles.push(fileContainers[i]);
        }
    } else {
        // 选中的文件
        const selectedCheckboxes = document.querySelectorAll('.copy-target-file:checked');
        if (selectedCheckboxes.length === 0) {
            alert('请至少选择一个目标文件');
            return;
        }
        
        selectedCheckboxes.forEach(checkbox => {
            const fileId = checkbox.value;
            const targetFile = document.querySelector(`.file-config-container[data-file-id="${fileId}"]`);
            if (targetFile) {
                targetFiles.push(targetFile);
            }
        });
    }
    
    try {
        // 收集第一个文件中所有启用的工作表配置
        const firstFileEnabledSheets = [];
        firstFile.querySelectorAll('.sheet-config-card').forEach(sheetCard => {
            const sheetCheckbox = sheetCard.querySelector('.sheet-enable');
            if (sheetCheckbox && sheetCheckbox.checked) {
                firstFileEnabledSheets.push({
                    name: sheetCard.dataset.sheetName,
                    headerRow: sheetCard.querySelector('.header-row')?.value || '1',
                    sourceName: sheetCard.querySelector('.source-name')?.value || ''
                });
            }
        });
        
        if (firstFileEnabledSheets.length === 0) {
            alert('第一个文件没有启用的工作表');
            return;
        }
        
        console.log('第一个文件启用的工作表:', firstFileEnabledSheets);
        
        let successCount = 0;
        let failCount = 0;
        let warnings = [];
        let copyDetails = {
            totalSheets: 0,
            copiedSheets: 0,
            skippedSheets: 0
        };
        
        // 应用到目标文件
        targetFiles.forEach((targetFile, fileIndex) => {
            try {
                const targetFileName = targetFile.querySelector('label.fw-bold')?.textContent.trim().split('(')[0].trim();
                
                // 遍历第一个文件的每个启用工作表
                firstFileEnabledSheets.forEach(sourceSheet => {
                    // 在目标文件中查找同名工作表
                    const targetSheetCard = Array.from(targetFile.querySelectorAll('.sheet-config-card'))
                        .find(card => card.dataset.sheetName === sourceSheet.name);
                    
                    if (targetSheetCard) {
                        copyDetails.totalSheets++;
                        
                        // 复制工作表启用状态
                        if (copySheet) {
                            const targetSheetCheckbox = targetSheetCard.querySelector('.sheet-enable');
                            if (targetSheetCheckbox) {
                                targetSheetCheckbox.checked = true;
                            }
                        }
                        
                        // 复制表头行
                        if (copyHeader) {
                            const targetHeaderRow = targetSheetCard.querySelector('.header-row');
                            if (targetHeaderRow) {
                                targetHeaderRow.value = sourceSheet.headerRow;
                            }
                        }
                        
                        // 复制数据源名称模式（保留目标文件名）
                        if (copySourceName) {
                            const targetSourceName = targetSheetCard.querySelector('.source-name');
                            if (targetSourceName && targetFileName) {
                                // 保持相同的命名模式：文件名 - 工作表名
                                targetSourceName.value = `${targetFileName} - ${sourceSheet.name}`;
                            }
                        }
                        
                        copyDetails.copiedSheets++;
                    } else {
                        // 目标文件中没有对应的工作表
                        copyDetails.skippedSheets++;
                        warnings.push(`文件"${targetFileName}"中没有工作表"${sourceSheet.name}"，已跳过`);
                    }
                });
                
                successCount++;
            } catch (error) {
                console.error(`复制配置到文件 ${fileIndex + 2} 失败:`, error);
                failCount++;
            }
        });
        
        // 关闭模态框
        const modal = bootstrap.Modal.getInstance(document.getElementById('copyFirstConfigModal'));
        if (modal) {
            modal.hide();
        }
        
        // 显示结果
        let message = `配置复制完成！\n`;
        message += `- 成功处理 ${successCount} 个文件\n`;
        message += `- 已启用工作表数: ${firstFileEnabledSheets.length}\n`;
        message += `- 成功复制: ${copyDetails.copiedSheets} 个工作表\n`;
        
        if (copyDetails.skippedSheets > 0) {
            message += `- 跳过: ${copyDetails.skippedSheets} 个工作表（目标文件中不存在）\n`;
        }
        
        if (failCount > 0) {
            message += `- 失败: ${failCount} 个文件\n`;
        }
        
        if (warnings.length > 0 && warnings.length <= 5) {
            message += `\n注意：\n` + warnings.join('\n');
        } else if (warnings.length > 5) {
            message += `\n注意：有 ${warnings.length} 个工作表被跳过`;
        }
        
        if (successCount > 0) {
            if (warnings.length > 0) {
                alert(message);
            } else {
                showSuccessToast(message.replace(/\n/g, ' '));
            }
        } else {
            alert('配置复制失败，请检查文件配置');
        }
        
    } catch (error) {
        console.error('复制配置失败:', error);
        alert('复制配置时发生错误：' + error.message);
    }
}

// 显示成功提示（Toast风格）
function showSuccessToast(message) {
    // 创建Toast元素
    const toastId = 'successToast_' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-check-circle-fill me-2"></i>${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    // 添加到页面
    document.body.insertAdjacentHTML('beforeend', toastHtml);
    
    // 显示Toast
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
    toast.show();
    
    // 自动移除
    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
}

// ================ 固定单元格配置功能 ================

// 启用/禁用固定单元格配置的显示控制
document.addEventListener('DOMContentLoaded', function() {
    const enableCheckbox = document.getElementById('enableFixedCells');
    const settingsDiv = document.getElementById('fixed-cells-settings');
    const noFixedCellsDiv = document.getElementById('no-fixed-cells');
    
    if (enableCheckbox && settingsDiv && noFixedCellsDiv) {
        enableCheckbox.addEventListener('change', function() {
            if (this.checked) {
                settingsDiv.style.display = 'block';
                noFixedCellsDiv.style.display = 'none';
            } else {
                settingsDiv.style.display = 'none';
                noFixedCellsDiv.style.display = 'block';
                // 清空配置表格
                const tableBody = document.getElementById('fixed-cells-table-body');
                if (tableBody) {
                    tableBody.innerHTML = '';
                }
            }
        });
    }
});

// 添加固定单元格配置行
function addFixedCellRow() {
    const tableBody = document.getElementById('fixed-cells-table-body');
    if (!tableBody) return;
    
    const row = document.createElement('tr');
    
    // 获取当前文件列表用于下拉选择
    const fileOptions = Array.from(document.querySelectorAll('.file-config')).map(config => {
        const fileId = config.dataset.fileId;
        const filename = config.querySelector('label').textContent.trim();
        return { fileId, filename };
    });
    
    const rowId = 'fixed-cell-row-' + Date.now();
    row.id = rowId;
    
    row.innerHTML = `
        <td>
            <input type="text" class="form-control form-control-sm fixed-cell-sheet-input" 
                   placeholder="如: 说明" required title="输入工作表名称，此规则将应用于所有文件中的同名工作表">
        </td>
        <td>
            <input type="text" class="form-control form-control-sm fixed-cell-address-input" 
                   placeholder="如: A1, B22" pattern="^[A-Z]+[0-9]+$" required
                   oninput="previewCellValue(this, '${rowId}')" title="输入Excel单元格地址，如A1、B22等">
        </td>
        <td>
            <input type="text" class="form-control form-control-sm fixed-cell-column-name" 
                   placeholder="新列名" required>
        </td>
        <td>
            <span class="badge bg-secondary fixed-cell-preview-value">未预览</span>
            <button type="button" class="btn btn-outline-primary btn-sm ms-1" 
                    onclick="previewCellValue(document.querySelector('#${rowId} .fixed-cell-address-input'), '${rowId}')">
                <i class="bi bi-eye"></i>
            </button>
        </td>
        <td>
            <button type="button" class="btn btn-danger btn-sm" onclick="removeFixedCellRow(this)">
                <i class="bi bi-trash"></i>
            </button>
        </td>
    `;
    
    tableBody.appendChild(row);
}

// 删除固定单元格配置行
function removeFixedCellRow(button) {
    const row = button.closest('tr');
    if (row) {
        row.remove();
    }
}

// 预览单元格值
async function previewCellValue(addressInput, rowId) {
    const row = document.getElementById(rowId);
    const sheetInput = row.querySelector('.fixed-cell-sheet-input');
    const previewElement = row.querySelector('.fixed-cell-preview-value');
    
    const sheetName = sheetInput?.value?.trim();
    const cellAddress = addressInput.value.trim().toUpperCase();
    
    // 验证单元格地址格式
    if (!cellAddress.match(/^[A-Z]+[0-9]+$/)) {
        previewElement.textContent = '格式错误';
        previewElement.className = 'badge bg-danger fixed-cell-preview-value';
        return;
    }
    
    if (!sheetName) {
        previewElement.textContent = '请输入工作表名称';
        previewElement.className = 'badge bg-warning fixed-cell-preview-value';
        return;
    }
    
    // 获取第一个启用的文件用于预览
    const firstEnabledFile = document.querySelector('.file-config .file-enable:checked');
    if (!firstEnabledFile) {
        previewElement.textContent = '请先启用至少一个文件';
        previewElement.className = 'badge bg-warning fixed-cell-preview-value';
        return;
    }
    
    const fileConfig = firstEnabledFile.closest('.file-config');
    const fileId = fileConfig.dataset.fileId;
    
    previewElement.textContent = '预览中...';
    previewElement.className = 'badge bg-info fixed-cell-preview-value';
    
    try {
        const response = await fetch('/api/preview_cell_value', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                file_id: fileId,
                sheet_name: sheetName,
                cell_address: cellAddress
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                const value = data.value;
                const fileName = fileConfig.querySelector('label').textContent.trim();
                previewElement.textContent = value || '(空值)';
                previewElement.className = 'badge bg-success fixed-cell-preview-value';
                previewElement.title = `来自【${fileName}】工作表【${sheetName}】单元格${cellAddress}的值: ${value}`;
            } else {
                previewElement.textContent = data.error || '预览失败';
                previewElement.className = 'badge bg-danger fixed-cell-preview-value';
            }
        } else {
            throw new Error('网络请求失败');
        }
    } catch (error) {
        console.error('预览单元格值失败:', error);
        previewElement.textContent = '预览失败';
        previewElement.className = 'badge bg-danger fixed-cell-preview-value';
    }
}

// ================ 配置管理功能 ================

// 显示配置管理模态框
function showConfigManager() {
    const modal = new bootstrap.Modal(document.getElementById('configManagerModal'));
    loadCachedConfigsForManager();
    modal.show();
}

// 加载缓存配置列表
function loadCachedConfigsForManager() {
    updateCachedConfigSelect();
}

// 获取当前所有配置（包括列类型配置）
function getCurrentConfig() {
    const config = {
        timestamp: new Date().toISOString(),
        version: '1.3',  // 版本升级以支持卡片式多工作表
        files: [],
        cleaning: {},
        columns: [],
        cellExtraction: {},
        export: {}
    };
    
    // 文件配置（新的卡片式布局）
    document.querySelectorAll('.file-config-container').forEach(fileContainer => {
        const fileId = fileContainer.dataset.fileId;
        const fileEnabled = fileContainer.querySelector('.file-enable').checked;
        
        // 收集该文件的所有工作表配置
        const sheets = [];
        fileContainer.querySelectorAll('.sheet-config-card').forEach(sheetCard => {
            const sheetEnabled = sheetCard.querySelector('.sheet-enable').checked;
            const sheetName = sheetCard.dataset.sheetName;
            const headerRow = parseInt(sheetCard.querySelector('.header-row').value);
            const sourceName = sheetCard.querySelector('.source-name').value;
            
            sheets.push({
                name: sheetName,
                enabled: sheetEnabled,
                headerRow: headerRow,
                sourceName: sourceName
            });
        });
        
        config.files.push({
            fileId,
            enabled: fileEnabled,
            sheets: sheets
        });
    });
    
    // 数据清洗配置
    config.cleaning = {
        cleanNumeric: document.getElementById('cleanNumeric')?.checked || false,
        parseDates: document.getElementById('parseDates')?.checked || false,
        removeDuplicates: document.getElementById('removeDuplicates')?.checked || false,
        removeEmptyRows: document.getElementById('removeEmptyRows')?.checked || false,
        keepStrategy: document.getElementById('keepStrategy')?.value || 'first',
        keyColumns: document.getElementById('keyColumns')?.value || '',
        mergeStrategy: document.getElementById('mergeStrategy')?.value || 'outer'
    };
    
    // 列配置（包括列类型配置的结果）
    document.querySelectorAll('#columnConfigBody tr').forEach(row => {
        const originalNameElement = row.querySelector('.original-column-name');
        const displayNameElement = row.querySelector('.display-column-name');
        const columnTypeElement = row.querySelector('.column-type');
        const visibleElement = row.querySelector('.column-visible');
        const orderElement = row.querySelector('.column-order');
        
        if (originalNameElement && displayNameElement && columnTypeElement && visibleElement && orderElement) {
            const originalName = originalNameElement.value || originalNameElement.textContent || '';
            const displayName = displayNameElement.value || '';
            const columnType = columnTypeElement.value || 'auto';
            const visible = visibleElement.checked;
            const order = parseInt(orderElement.value) || 0;
            
            config.columns.push({
                originalName,
                displayName: displayName || originalName,
                columnType,
                visible,
                order
            });
        }
    });
    
    // 单元格截取配置
    config.cellExtraction = {
        enabled: document.getElementById('enableCellExtraction')?.checked || false,
        rules: []
    };
    
    if (config.cellExtraction.enabled) {
        document.querySelectorAll('#cellExtractionBody tr').forEach(row => {
            const fileId = row.querySelector('.extraction-file-select')?.value;
            const sheetName = row.querySelector('.extraction-sheet-input')?.value?.trim();
            const rowNum = row.querySelector('.extraction-row-input')?.value?.trim();
            const colNum = row.querySelector('.extraction-col-input')?.value?.trim();
            const newColumnName = row.querySelector('.extraction-column-name')?.value?.trim();
            const dataType = row.querySelector('.extraction-data-type')?.value;
            const description = row.querySelector('.extraction-description')?.value?.trim();
            
            if (fileId && rowNum && colNum && newColumnName) {
                config.cellExtraction.rules.push({
                    fileId,
                    sheetName: sheetName || null,
                    rowNumber: parseInt(rowNum),
                    columnNumber: parseInt(colNum),
                    newColumnName,
                    dataType,
                    description
                });
            }
        });
    }
    
    // 固定单元格配置
    config.fixedCells = {
        enabled: document.getElementById('enableFixedCells')?.checked || false,
        rules: []
    };
    
    if (config.fixedCells.enabled) {
        document.querySelectorAll('#fixed-cells-table-body tr').forEach(row => {
            const sheetName = row.querySelector('.fixed-cell-sheet-input')?.value?.trim();
            const cellAddress = row.querySelector('.fixed-cell-address-input')?.value?.trim().toUpperCase();
            const newColumnName = row.querySelector('.fixed-cell-column-name')?.value?.trim();
            
            if (sheetName && cellAddress && newColumnName) {
                // 验证单元格地址格式
                if (cellAddress.match(/^[A-Z]+[0-9]+$/)) {
                    config.fixedCells.rules.push({
                        sheetName,
                        cellAddress,
                        newColumnName
                    });
                }
            }
        });
    }
    
    // 导出配置
    config.export = {
        format: document.getElementById('exportFormat')?.value || 'xlsx',
        filename: document.getElementById('exportFilename')?.value || 'merged_data'
    };
    
    return config;
}

// 导出配置到文件
function doExportConfig() {
    try {
        const config = getCurrentConfig();
        const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `excel_merge_config_${new Date().toISOString().slice(0, 19).replace(/[T:]/g, '_')}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // 移除模态框内所有按钮的焦点
        const modal = document.getElementById('configManagerModal');
        modal.querySelectorAll('button').forEach(btn => btn.blur());
        
        setTimeout(() => {
            alert('配置文件已导出');
        }, 100);
    } catch (error) {
        alert('导出配置失败：' + error.message);
    }
}

// 导入配置文件
function doImportConfig() {
    const fileInput = document.getElementById('configFileInput');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('请选择配置文件');
        return;
    }
    
    if (!file.name.toLowerCase().endsWith('.json')) {
        alert('请选择JSON格式的配置文件');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const config = JSON.parse(e.target.result);
            applyImportedConfig(config);
            
            // 移除模态框内所有按钮的焦点
            const modal = document.getElementById('configManagerModal');
            modal.querySelectorAll('button').forEach(btn => btn.blur());
            
            // 关闭模态框
            const modalInstance = bootstrap.Modal.getInstance(modal);
            if (modalInstance) {
                modalInstance.hide();
            }
            
            // 延迟显示成功消息
            setTimeout(() => {
                alert('配置已成功导入');
            }, 300);
        } catch (error) {
            alert('配置文件格式错误：' + error.message);
        }
    };
    reader.readAsText(file);
}

// 应用导入的配置
function applyImportedConfig(config) {
    // 应用文件配置
    if (config.files) {
        config.files.forEach(fileConfig => {
            const fileContainer = document.querySelector(`.file-config-container[data-file-id="${fileConfig.fileId}"]`);
            if (!fileContainer) return;
            
            const fileCheckbox = fileContainer.querySelector('.file-enable');
            if (fileCheckbox) {
                fileCheckbox.checked = fileConfig.enabled;
            }
            
            const sheetsContainer = fileContainer.querySelector('.sheets-container');
            if (!sheetsContainer) return;
            
            // 清空现有工作表配置
            sheetsContainer.innerHTML = '';
            
            // 根据配置版本处理不同格式
            if (config.version === '1.3' && Array.isArray(fileConfig.sheets)) {
                // v1.3 格式：完整的工作表配置对象数组
                fileConfig.sheets.forEach((sheetConfig, index) => {
                    const fileName = fileContainer.querySelector('.fw-bold').textContent.trim().split('(')[0].trim();
                    const cardHtml = `
                        <div class="card mb-2 sheet-config-card" data-sheet-name="${sheetConfig.name}">
                            <div class="card-body py-2">
                                <div class="row align-items-center">
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input sheet-enable" type="checkbox" 
                                                   id="sheet_${fileConfig.fileId}_${index}" 
                                                   ${sheetConfig.enabled ? 'checked' : ''}>
                                            <label class="form-check-label" for="sheet_${fileConfig.fileId}_${index}">
                                                <strong><i class="bi bi-file-earmark-spreadsheet"></i> ${sheetConfig.name}</strong>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label mb-0 small">表头行</label>
                                        <input type="number" class="form-control form-control-sm header-row" 
                                               value="${sheetConfig.headerRow}" min="1">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label mb-0 small">数据源名称</label>
                                        <input type="text" class="form-control form-control-sm source-name" 
                                               value="${sheetConfig.sourceName}">
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                                onclick="previewSheetConfig('${fileConfig.fileId}', '${sheetConfig.name}', this)" 
                                                title="预览此工作表">
                                            <i class="bi bi-eye"></i> 预览
                                        </button>
                                        <button type="button" class="btn btn-outline-info btn-sm" 
                                                onclick="detectSheetColumns('${fileConfig.fileId}', '${sheetConfig.name}', this)" 
                                                title="检测此工作表列类型">
                                            <i class="bi bi-search"></i> 检测
                                        </button>
                                        ${index > 0 ? `
                                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                                onclick="removeSheetConfig(this)" 
                                                title="移除此工作表">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    sheetsContainer.insertAdjacentHTML('beforeend', cardHtml);
                });
            } else if (Array.isArray(fileConfig.sheets)) {
                // v1.2 格式兼容：简单的工作表名称数组
                fileConfig.sheets.forEach((sheetName, index) => {
                    const fileName = fileContainer.querySelector('.fw-bold').textContent.trim().split('(')[0].trim();
                    const cardHtml = createSheetConfigCard(
                        fileConfig.fileId, 
                        sheetName, 
                        fileName
                    );
                    sheetsContainer.insertAdjacentHTML('beforeend', cardHtml);
                });
            } else if (fileConfig.sheet) {
                // v1.1 及以前格式兼容：单个工作表
                const fileName = fileContainer.querySelector('.fw-bold').textContent.trim().split('(')[0].trim();
                const cardHtml = createSheetConfigCard(
                    fileConfig.fileId, 
                    fileConfig.sheet, 
                    fileName
                );
                sheetsContainer.insertAdjacentHTML('beforeend', cardHtml);
            }
        });
    }
    
    // 应用数据清洗配置
    if (config.cleaning) {
        const cleaningConfig = config.cleaning;
        
        if (document.getElementById('cleanNumeric')) document.getElementById('cleanNumeric').checked = cleaningConfig.cleanNumeric;
        if (document.getElementById('parseDates')) document.getElementById('parseDates').checked = cleaningConfig.parseDates;
        if (document.getElementById('removeDuplicates')) document.getElementById('removeDuplicates').checked = cleaningConfig.removeDuplicates;
        if (document.getElementById('removeEmptyRows')) document.getElementById('removeEmptyRows').checked = cleaningConfig.removeEmptyRows;
        if (document.getElementById('keepStrategy')) document.getElementById('keepStrategy').value = cleaningConfig.keepStrategy;
        if (document.getElementById('keyColumns')) document.getElementById('keyColumns').value = cleaningConfig.keyColumns;
        if (document.getElementById('mergeStrategy')) document.getElementById('mergeStrategy').value = cleaningConfig.mergeStrategy;
    }
    
    // 应用导出配置
    if (config.export) {
        if (document.getElementById('exportFormat')) document.getElementById('exportFormat').value = config.export.format;
        if (document.getElementById('exportFilename')) document.getElementById('exportFilename').value = config.export.filename;
    }
    
    // 如果有列配置，重新加载列配置表格
    if (config.columns && config.columns.length > 0) {
        const tbody = document.getElementById('columnConfigBody');
        if (tbody) {
            tbody.innerHTML = '';
            
            config.columns.forEach(columnConfig => {
                addColumnConfigRow(
                    columnConfig.originalName,
                    columnConfig.displayName,
                    columnConfig.columnType,
                    columnConfig.visible,
                    columnConfig.order
                );
            });
        }
    }
    
    // 应用单元格截取配置
    if (config.cellExtraction) {
        const enableCheckbox = document.getElementById('enableCellExtraction');
        if (enableCheckbox) {
            enableCheckbox.checked = config.cellExtraction.enabled || false;
            // 触发变化事件以显示/隐藏设置区域
            enableCheckbox.dispatchEvent(new Event('change'));
        }
        
        // 清空现有规则
        const tbody = document.getElementById('cellExtractionBody');
        if (tbody) {
            tbody.innerHTML = '';
        }
        
        // 添加导入的规则
        if (config.cellExtraction.rules && config.cellExtraction.rules.length > 0) {
            config.cellExtraction.rules.forEach(rule => {
                addCellExtractionRule();
                const lastRow = tbody.lastElementChild;
                if (lastRow) {
                    lastRow.querySelector('.extraction-file-select').value = rule.fileId || '';
                    lastRow.querySelector('.extraction-sheet-input').value = rule.sheetName || '';
                    lastRow.querySelector('.extraction-row-input').value = rule.rowNumber || '';
                    lastRow.querySelector('.extraction-col-input').value = rule.columnNumber || '';
                    lastRow.querySelector('.extraction-column-name').value = rule.newColumnName || '';
                    lastRow.querySelector('.extraction-data-type').value = rule.dataType || 'text';
                    lastRow.querySelector('.extraction-description').value = rule.description || '';
                }
            });
        }
    }
    
    // 应用固定单元格配置
    if (config.fixedCells) {
        const enableCheckbox = document.getElementById('enableFixedCells');
        if (enableCheckbox) {
            enableCheckbox.checked = config.fixedCells.enabled || false;
            // 触发变化事件以显示/隐藏设置区域
            enableCheckbox.dispatchEvent(new Event('change'));
        }
        
        // 清空现有规则
        const tbody = document.getElementById('fixed-cells-table-body');
        if (tbody) {
            tbody.innerHTML = '';
        }
        
        // 添加导入的规则
        if (config.fixedCells.rules && config.fixedCells.rules.length > 0) {
            config.fixedCells.rules.forEach(rule => {
                addFixedCellRow();
                const lastRow = tbody.lastElementChild;
                if (lastRow) {
                    // 设置工作表名称
                    const sheetInput = lastRow.querySelector('.fixed-cell-sheet-input');
                    if (sheetInput && rule.sheetName) {
                        sheetInput.value = rule.sheetName;
                    }
                    
                    // 设置单元格地址
                    const addressInput = lastRow.querySelector('.fixed-cell-address-input');
                    if (addressInput && rule.cellAddress) {
                        addressInput.value = rule.cellAddress;
                        // 触发预览更新
                        if (lastRow.id) {
                            previewCellValue(addressInput, lastRow.id);
                        }
                    }
                    
                    // 设置列名
                    const columnNameInput = lastRow.querySelector('.fixed-cell-column-name');
                    if (columnNameInput && rule.newColumnName) {
                        columnNameInput.value = rule.newColumnName;
                    }
                }
            });
        }
    }
}

// 预览当前配置
function previewCurrentConfig() {
    try {
        const config = getCurrentConfig();
        document.getElementById('configPreview').textContent = JSON.stringify(config, null, 2);
    } catch (error) {
        document.getElementById('configPreview').textContent = '获取配置失败：' + error.message;
    }
}

// ================ 配置缓存功能 ================

// 获取缓存配置的存储键名（全局配置，不依赖具体文件）
function getCacheKey() {
    return 'excel_merge_configs_global';
}

// 从localStorage加载缓存的配置
function loadCachedConfigs() {
    try {
        const cache = localStorage.getItem(getCacheKey());
        return cache ? JSON.parse(cache) : {};
    } catch (error) {
        console.error('加载缓存配置失败:', error);
        return {};
    }
}

// 保存配置到localStorage
function saveCachedConfigs(configs) {
    try {
        localStorage.setItem(getCacheKey(), JSON.stringify(configs));
        return true;
    } catch (error) {
        console.error('保存缓存配置失败:', error);
        alert('保存配置失败，可能是存储空间不足：' + error.message);
        return false;
    }
}

// 更新缓存配置下拉列表
function updateCachedConfigSelect() {
    const select = document.getElementById('cachedConfigSelect');
    const configs = loadCachedConfigs();
    
    // 清空现有选项
    select.innerHTML = '<option value="">选择要应用的历史配置...</option>';
    
    // 添加缓存的配置选项
    Object.keys(configs).forEach(name => {
        const config = configs[name];
        const option = document.createElement('option');
        option.value = name;
        
        // 显示配置名称和元数据
        const metadata = config.metadata || {};
        const saveTime = metadata.savedAt ? new Date(metadata.savedAt).toLocaleString('zh-CN') : 
                        (config.timestamp ? new Date(config.timestamp).toLocaleString('zh-CN') : '未知时间');
        const description = metadata.description || '';
        
        option.textContent = `${name}${description ? ' - ' + description : ''} (${saveTime})`;
        option.title = `配置名称: ${name}\n保存时间: ${saveTime}${description ? '\n适用场景: ' + description : ''}\n版本: ${config.version || '1.0'}`;
        
        select.appendChild(option);
    });
}

// 保存当前配置到缓存
function saveCurrentConfigToCache() {
    const nameInput = document.getElementById('configCacheName');
    const configName = nameInput.value.trim();
    
    if (!configName) {
        alert('请输入配置名称');
        nameInput.focus();
        return;
    }
    
    try {
        const currentConfig = getCurrentConfig();
        const configs = loadCachedConfigs();
        
        // 添加配置元数据，帮助用户识别适用场景
        const fileConfigs = document.querySelectorAll('.file-config');
        const fileCount = fileConfigs.length;
        const fileTypes = [];
        fileConfigs.forEach(fc => {
            const label = fc.querySelector('label')?.textContent || '';
            const ext = label.match(/\.(xlsx?|csv)$/i);
            if (ext) fileTypes.push(ext[1]);
        });
        
        currentConfig.metadata = {
            fileCount: fileCount,
            fileTypes: [...new Set(fileTypes)].join(', '),
            savedAt: new Date().toISOString(),
            description: `${fileCount}个文件的配置 (${[...new Set(fileTypes)].join(', ') || '未知类型'})`
        };
        
        // 检查是否已存在同名配置
        if (configs[configName]) {
            if (!confirm(`配置 "${configName}" 已存在，是否覆盖？`)) {
                return;
            }
        }
        
        // 保存配置
        configs[configName] = currentConfig;
        
        if (saveCachedConfigs(configs)) {
            alert(`配置 "${configName}" 已保存到缓存\n适用场景: ${currentConfig.metadata.description}`);
            nameInput.value = '';
            updateCachedConfigSelect();
        }
        
    } catch (error) {
        alert('保存配置失败：' + error.message);
    }
}

// 应用缓存的配置
function applyCachedConfig() {
    const select = document.getElementById('cachedConfigSelect');
    const configName = select.value;
    
    if (!configName) {
        alert('请选择要应用的配置');
        return;
    }
    
    try {
        const configs = loadCachedConfigs();
        const config = configs[configName];
        
        if (!config) {
            alert('找不到指定的配置');
            return;
        }
        
        if (confirm(`确定要应用配置 "${configName}" 吗？这将覆盖当前所有设置。`)) {
            applyImportedConfig(config);
            
            // 首先移除模态框内所有按钮的焦点
            const modal = document.getElementById('configManagerModal');
            modal.querySelectorAll('button').forEach(btn => btn.blur());
            
            // 关闭模态框
            const modalInstance = bootstrap.Modal.getInstance(modal);
            if (modalInstance) {
                modalInstance.hide();
            }
            
            // 延迟显示成功消息，确保模态框完全关闭
            setTimeout(() => {
                alert('配置已成功应用');
            }, 300);
        }
        
    } catch (error) {
        alert('应用配置失败：' + error.message);
    }
}

// 清空所有缓存配置
function clearCachedConfigs() {
    const configs = loadCachedConfigs();
    const configCount = Object.keys(configs).length;
    
    if (configCount === 0) {
        alert('没有缓存的配置需要清空');
        return;
    }
    
    if (confirm(`确定要清空所有 ${configCount} 个缓存配置吗？此操作不可恢复。`)) {
        try {
            localStorage.removeItem(getCacheKey());
            updateCachedConfigSelect();
            alert('缓存配置已清空');
        } catch (error) {
            alert('清空缓存失败：' + error.message);
        }
    }
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    // 为所有模态框添加通用的焦点管理
    const modals = ['configManagerModal', 'previewModal', 'columnTypesModal', 'copyFirstConfigModal'];
    modals.forEach(modalId => {
        const modalElement = document.getElementById(modalId);
        if (modalElement) {
            modalElement.addEventListener('hidden.bs.modal', function () {
                // 模态框关闭时移除所有按钮的焦点
                modalElement.querySelectorAll('button, [data-bs-dismiss]').forEach(element => {
                    element.blur();
                });
            });
        }
    });
});

// ================ 多工作表汇总功能 ================

// 展开/折叠工作表容器
function toggleSheetsContainer(fileId) {
    const container = document.getElementById(`sheets_body_${fileId}`);
    const btn = document.getElementById(`toggle_btn_${fileId}`);
    const icon = btn.querySelector('i');
    const text = btn.querySelector('.toggle-text');
    
    if (container.style.display === 'none') {
        container.style.display = 'block';
        icon.className = 'bi bi-chevron-up';
        text.textContent = '折叠';
    } else {
        container.style.display = 'none';
        icon.className = 'bi bi-chevron-down';
        text.textContent = '展开';
    }
}

// 添加工作表配置卡片
function addSheetConfig(fileId) {
    const container = document.getElementById(`sheets_${fileId}`);
    const fileContainer = document.querySelector(`[data-file-id="${fileId}"]`);
    const fileName = fileContainer.querySelector('.fw-bold').textContent.trim().split('(')[0].trim();
    
    // 获取可用的工作表列表
    const existingSheets = Array.from(container.querySelectorAll('.sheet-config-card'))
        .map(card => card.dataset.sheetName);
    
    // 提示用户输入工作表名称
    const sheetName = prompt('请输入要添加的工作表名称：', 'Sheet' + (existingSheets.length + 1));
    
    if (!sheetName || !sheetName.trim()) {
        return;
    }
    
    if (existingSheets.includes(sheetName.trim())) {
        alert('该工作表已存在！');
        return;
    }
    
    const sheetCard = createSheetConfigCard(fileId, sheetName.trim(), fileName);
    container.insertAdjacentHTML('beforeend', sheetCard);
    
    showSuccessToast(`已添加工作表：${sheetName}`);
}

// 创建工作表配置卡片HTML
function createSheetConfigCard(fileId, sheetName, fileName) {
    const cardId = `sheet_${fileId}_${Date.now()}`;
    return `
        <div class="card mb-2 sheet-config-card" data-sheet-name="${sheetName}">
            <div class="card-body py-2">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <div class="form-check">
                            <input class="form-check-input sheet-enable" type="checkbox" 
                                   id="${cardId}" checked>
                            <label class="form-check-label" for="${cardId}">
                                <strong><i class="bi bi-file-earmark-spreadsheet"></i> ${sheetName}</strong>
                            </label>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label mb-0 small">表头行</label>
                        <input type="number" class="form-control form-control-sm header-row" 
                               value="1" min="1">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label mb-0 small">数据源名称</label>
                        <input type="text" class="form-control form-control-sm source-name" 
                               value="${fileName} - ${sheetName}">
                    </div>
                    <div class="col-md-4 text-end">
                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                onclick="previewSheetConfig('${fileId}', '${sheetName}', this)" 
                                title="预览此工作表">
                            <i class="bi bi-eye"></i> 预览
                        </button>
                        <button type="button" class="btn btn-outline-info btn-sm" 
                                onclick="detectSheetColumns('${fileId}', '${sheetName}', this)" 
                                title="检测此工作表列类型">
                            <i class="bi bi-search"></i> 检测
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                onclick="removeSheetConfig(this)" 
                                title="移除此工作表">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// 移除工作表配置
function removeSheetConfig(button) {
    const card = button.closest('.sheet-config-card');
    const sheetName = card.dataset.sheetName;
    
    if (confirm(`确定要移除工作表"${sheetName}"的配置吗？`)) {
        card.remove();
        showSuccessToast(`已移除工作表：${sheetName}`);
    }
}

// 预览工作表配置
function previewSheetConfig(fileId, sheetName, button) {
    const card = button.closest('.sheet-config-card');
    const headerRow = card.querySelector('.header-row').value;
    
    const url = `/api/preview/${fileId}?` + 
                new URLSearchParams({
                    sheet_name: sheetName,
                    header_row: parseInt(headerRow) - 1,
                    rows: 20
                });
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayPreviewData(data.data, `工作表预览 - ${sheetName}`);
                const modal = new bootstrap.Modal(document.getElementById('previewModal'));
                modal.show();
            } else {
                alert('预览失败：' + data.error);
            }
        })
        .catch(error => {
            alert('预览失败：' + error.message);
        });
}

// 检测工作表列类型
function detectSheetColumns(fileId, sheetName, button) {
    const card = button.closest('.sheet-config-card');
    const headerRow = card.querySelector('.header-row').value;
    
    const url = `/api/detect_columns/${fileId}?` + 
                new URLSearchParams({
                    sheet_name: sheetName,
                    header_row: parseInt(headerRow) - 1
                });
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayColumnTypes(data.column_types, data.columns);
                const modal = new bootstrap.Modal(document.getElementById('columnTypesModal'));
                modal.show();
            } else {
                alert('检测失败：' + data.error);
            }
        })
        .catch(error => {
            alert('检测失败：' + error.message);
        });
}

// 旧的切换多工作表函数（已废弃，但保留以兼容）
function toggleMultipleSheets() {
    // 不再需要此函数，但保留空实现以防其他地方调用
    console.log('toggleMultipleSheets 已废弃，现在默认支持多工作表');
}
</script>
{% endblock %}